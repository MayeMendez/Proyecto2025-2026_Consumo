<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Editar Zona y Rutas</title>

<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
	rel="stylesheet">
</head>
<body>

	<div class="container mt-4">
		<div class="card shadow">
			<div class="card-body">

				<h4 class="mb-3" th:text="${titulo}">Editar Zona y Rutas</h4>

				<form th:object="${form}" th:action="@{/zonas/actualizar-con-rutas}"
					method="post">

					<!-- ID ZONA -->
					<input type="hidden" th:field="*{zona.id_zona_entrega}" />

					<!-- ================= ZONA ================= -->
					<h5>Datos de la Zona</h5>

					<div class="row g-3">
						<div class="col-md-4">
							<label class="form-label">Zona</label> <select
								class="form-select" th:field="*{zona.nombre_zona}" required>
								<option value="">-- Seleccione --</option>
								<option value="NORTE">NORTE</option>
								<option value="CENTRO">CENTRO</option>
								<option value="SUR">SUR</option>
							</select>
						</div>

						<div class="col-md-4">
							<label class="form-label">Ciudad</label> <input
								class="form-control" th:field="*{zona.ciudad}" required>
						</div>

						<div class="col-md-4">
							<label class="form-label">Provincia</label> <input
								class="form-control" th:field="*{zona.provincia}" required>
						</div>
					</div>

					<hr class="my-4">

					<!-- ================= RUTAS ================= -->
					<div class="d-flex justify-content-between align-items-center">
						<h5 class="mb-0">Rutas de la Zona</h5>
						<button type="button" class="btn btn-primary btn-sm"
							onclick="agregarRuta()">+ Agregar Ruta</button>
					</div>

					<div id="rutasContainer" class="mt-3">

						<div class="row g-3 ruta-item align-items-end"
							th:each="r, stat : *{rutas}">

							<!-- ID RUTA -->
							<input type="hidden"
								th:field="*{rutas[__${stat.index}__].id_ruta_entrega}" />

							<div class="col-md-5">
								<label class="form-label">Nombre Ruta</label> <input
									class="form-control"
									th:field="*{rutas[__${stat.index}__].nombre_ruta}">
							</div>

							<div class="col-md-3">
								<label class="form-label">Distancia (km)</label> <input
									type="number" step="0.01" min="0" class="form-control"
									th:field="*{rutas[__${stat.index}__].distancia_estimada_km}">
							</div>

							<div class="col-md-2">
								<label class="form-label">Tiempo (min)</label> <input
									type="number" min="1" class="form-control"
									th:field="*{rutas[__${stat.index}__].tiempo_estimado_min}">
							</div>

							<div class="col-md-2 d-flex gap-1">

								<button type="button" class="btn btn-outline-danger btn-sm"
									onclick="eliminarRutaPantalla(this)" title="Quitar de pantalla">X</button>

							
								<a class="btn btn-danger btn-sm"
									th:if="${r.id_ruta_entrega != null and r.id_ruta_entrega > 0}"
									th:href="@{/rutas/eliminar/{id}(id=${r.id_ruta_entrega}, zonaId=${form.zona.id_zona_entrega})}"
									onclick="return confirm('Â¿Eliminar esta ruta definitivamente?');"
									title="Eliminar de la base de datos">ðŸ—‘</a>

							</div>
						</div>
					</div>

					<div class="mt-4 d-flex gap-2">
						<button type="submit" class="btn btn-warning">Actualizar</button>
						<a th:href="@{/zonas}" class="btn btn-secondary">Cancelar</a>
					</div>

				</form>
			</div>
		</div>
	</div>

	<!-- ================= JS ================= -->
	<script>
function agregarRuta() {
  const container = document.getElementById("rutasContainer");
  const index = container.querySelectorAll(".ruta-item").length;

  const html = `
  <div class="row g-3 ruta-item align-items-end mt-2">

    <input type="hidden" name="rutas[${index}].id_ruta_entrega" value="">

    <div class="col-md-5">
      <input class="form-control"
             name="rutas[${index}].nombre_ruta"
             placeholder="Nombre Ruta">
    </div>

    <div class="col-md-3">
      <input type="number" step="0.01" min="0"
             class="form-control"
             name="rutas[${index}].distancia_estimada_km"
             placeholder="Km">
    </div>

    <div class="col-md-2">
      <input type="number" min="1"
             class="form-control"
             name="rutas[${index}].tiempo_estimado_min"
             placeholder="Min">
    </div>

    <div class="col-md-2">
      <button type="button"
              class="btn btn-outline-danger btn-sm"
              onclick="eliminarRutaPantalla(this)">X</button>
    </div>

  </div>`;
  container.insertAdjacentHTML("beforeend", html);
}

function eliminarRutaPantalla(btn) {
  btn.closest(".ruta-item").remove();
}
</script>

</body>
</html>
